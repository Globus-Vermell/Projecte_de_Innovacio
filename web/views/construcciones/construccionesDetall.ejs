<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= building.name %> - Detalle
    </title>
</head>

<body>
    <h1>Nombre: <%= building.name %>
    </h1>
    <p>Descripción: <%= building.description %>
    </p>
    <div>
        <p>Imagen:</p> <img src="/images/buildings/<%= building.picture %>" alt="<%= building.name %>" />
    </div>
    <p>Dirección: <%= building.coordinates %>
    </p>
    <p>Año de construcción: <%= building.constucyion_year %>
    </p>
    <p>Descripción: <%= building.description || "Sin descripción disponible" %>
    </p>
    <p>Superficie de area: <%= building.surface_area || "Sin superficie de area disponible" %>
    </p>

    <p>Premios:
        <span id="prize-id"></span>
    </p>
    <p>
        <% if (building.id_nomenclature) { %>
            <a href="/nomenclatura/<%= building.id_nomenclature %>">Nomenclatura: <span id="nom-name"></span></a>
            <% } else { %>
                <p>Nomenclatura: Sin nomenclatura disponible</p>
                <% } %>
    </p>

    <p>
        <% if (building.id_publication) { %>
            <a href="/publicaciones/<%= building.id_publication %>">Publicación: <span id="pub-title"></span></a>

            <% } else { %>
                <p>Publicaciones: Sin publicaciones disponibles</p>
                <% } %>
    </p>

    <p>Reformas:
        <span id="ref-year"></span>
    </p>

    <p>
        <% if (building.id_architect) { %>
            <a href="/arquitectos/<%= building.id_architect %>">Arquitecto: <span id="arch-name"></span></a>
            <% } else { %>
                <p>Arquitectos: Sin arquitectos disponibles</p>
                <% } %>
    </p>

    <p>
        <% if (building.id_typology) { %>
            <a href="/tipologias/<%= building.id_typology %>">Tipología: <span id="typ-name"></span></a>
            <% } else { %>
                <p>Tipologías: Sin tipologías disponibles</p>
                <% } %>
    </p>

    <p>
        <% if (building.id_protection) { %>
            <a href="/proteccion/<%= building.id_protection %>">Protección: <span id="prot-level"></span></a>
            <% } else { %>
                <p>Protecciones: Sin protecciones disponibles</p>
                <% } %>
    </p>

    <a href="/construcciones">Volver al listado</a>
</body>

</html>
<script>
    /**
     * Fetches and displays prize names for a given building ID.
     *
     * @param {number} buildingId - The ID of the building.
     * @param {HTMLElement} targetElement - The HTML element where the prize links will be appended.
     * @returns {Promise<void>} A promise that resolves when the prizes are displayed or rejects on error.
     */
    async function displayBuildingPrizes(buildingId, targetElement) {
        if (!buildingId || !targetElement) {
            console.error("Building ID and target element are required.");
            return;
        }

        try {
            // 1. Fetch prize IDs for the building
            const buildingPrizesResponse = await fetch(`/construcciones/${buildingId}/prizes`);
            if (!buildingPrizesResponse.ok) {
                throw new Error(`Failed to fetch prizes for building ${buildingId}: ${buildingPrizesResponse.statusText}`);
            }
            const buildingPrizesData = await buildingPrizesResponse.json();

            if (!buildingPrizesData || !buildingPrizesData.prizes || buildingPrizesData.prizes.length === 0) {
                console.log(`No prizes found for building ${buildingId}.`);
                return;
            }

            // 2. Fetch prize names for each prize ID and append to the target element
            for (let i = 0; i < buildingPrizesData.prizes.length; i++) {
                const prizeId = buildingPrizesData.prizes[i];

                try {
                    const prizeNameResponse = await fetch(`/premios/${prizeId}/name`);
                    if (!prizeNameResponse.ok) {
                        throw new Error(`Failed to fetch name for prize ${prizeId}: ${prizeNameResponse.statusText}`);
                    }
                    const prizeNameData = await prizeNameResponse.json();

                    if (prizeNameData && prizeNameData.prize) {
                        const link = document.createElement('a');
                        link.href = `/premios/${prizeId}`;
                        link.textContent = prizeNameData.prize;
                        targetElement.appendChild(link);

                        // Add a comma if it's not the last prize
                        if (i < buildingPrizesData.prizes.length - 1) {
                            targetElement.appendChild(document.createTextNode(', '));
                        }
                    }
                } catch (prizeNameError) {
                    console.warn(`Could not fetch name for prize ID ${prizeId}. Error: ${prizeNameError.message}`);
                    // Optionally, you could append the ID here if the name fetch fails
                    // targetElement.appendChild(document.createTextNode(prizeId));
                    // if (i < buildingPrizesData.prizes.length - 1) {
                    //     targetElement.appendChild(document.createTextNode(', '));
                    // }
                }
            }
        } catch (buildingPrizesError) {
            console.error(`Error displaying prizes for building ${buildingId}:`, buildingPrizesError.message);
            // Optionally, handle the error visually in the UI, e.g., targetElement.textContent = "Error al cargar premios.";
        }
    }


    async function loadAndDisplayData(resourceId, baseUrl, elementId, propertyName) {
        // Si resourceId es null, undefined, o 0, no intentamos hacer la petición
        // Esto es útil si algunos campos en building pueden ser nulos
        if (!resourceId) {
            // console.warn(`ID de recurso no proporcionado para ${baseUrl}. No se realizará la petición.`);
            return;
        }

        try {
            const response = await fetch(`${baseUrl}${resourceId}/${propertyName}`);

            if (!response.ok) {
                // Si la respuesta no es OK (ej. 404), lanzamos un error para ir al catch
                throw new Error(`Error al obtener ${propertyName} de ${baseUrl}${resourceId}: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const targetElement = document.getElementById(elementId);

            // Verificamos si el elemento existe en el DOM y si el dato existe en la respuesta
            if (targetElement && data && data[propertyName]) {
                targetElement.textContent = data[propertyName];
            } else if (!targetElement) {
                console.warn(`Elemento con ID "${elementId}" no encontrado en el DOM.`);
            } else {
                console.warn(`Propiedad "${propertyName}" no encontrada en los datos para ${baseUrl}${resourceId}.`);
            }

        } catch (error) {
            console.error("Fallo al cargar o mostrar el dato:", error);
            // Aquí puedes decidir si quieres limpiar el elemento o dejarlo como está.
            // El requisito original era "Dejar el id si falla la petición",
            // lo que significa no cambiar el textContent, así que no hacemos nada aquí.
        }
    }

    async function displayBuildingReforms(buildingId, targetElement) {
        if (!buildingId || !targetElement) {
            console.error("Building ID and target element are required.");
            return;
        }

        try {
            // Fetch reform years for the building
            const buildingReformsResponse = await fetch(`/construcciones/${buildingId}/reforms`);
            if (!buildingReformsResponse.ok) {
                throw new Error(`Failed to fetch reforms for building ${buildingId}: ${buildingReformsResponse.statusText}`);
            }
            const buildingReformsData = await buildingReformsResponse.json();

            if (!buildingReformsData || !buildingReformsData.reforms || buildingReformsData.reforms.length === 0) {
                console.log(`No reforms found for building ${buildingId}.`);
                return;
            }

            // Append reform years to the target element
            buildingReformsData.reforms.forEach((reform, index) => {
                const span = document.createElement('span');
                span.textContent = reform.year;
                targetElement.appendChild(span);

                // Add a comma if it's not the last reform
                if (index < buildingReformsData.reforms.length - 1) {
                    targetElement.appendChild(document.createTextNode(', '));
                }
            });
        } catch (error) {
            console.error(`Error displaying reforms for building ${buildingId}:`, error.message);
        }
    }


    (async () => {
        const buildingId = "<%= building.id_building %>";
        console.log("<%= building.id_building %>");
        const prizeElement = document.getElementById('prize-id');
        await displayBuildingPrizes(buildingId, prizeElement);
    })();

    (async () => {
        const refId = "<%= building.id_building %>";
        const reformElement = document.getElementById('ref-year');
        console.log(reformElement);
        await displayBuildingReforms(refId, reformElement);
    })();
    


    (async () => {
        const refId = "<%= building.id_publication %>";
        await loadAndDisplayData(refId, '/publicaciones/', 'pub-title', 'title');
    })();


    (async () => {
        const nomId = "<%= building.id_nomenclature %>";
        await loadAndDisplayData(nomId, '/nomenclatura/', 'nom-name', 'name');
    })();


    (async () => {
        const archId = "<%= building.id_architect %>";
        await loadAndDisplayData(archId, '/arquitectos/', 'arch-name', 'name');
    })();

    (async () => {
        const typId = "<%= building.id_typology %>";
        await loadAndDisplayData(typId, '/tipologia/', 'typ-name', 'name');
    })();

    (async () => {
        const protId = "<%= building.id_protection %>";
        await loadAndDisplayData(protId, '/proteccion/', 'prot-level', 'level');
    })();

</script>